name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  migrate-and-deploy:
    name: Run Migrations & Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—„ï¸ Install PostgreSQL client (matching server version)
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          sudo apt-get update
          # Install basic tools and PostgreSQL repository setup
          sudo apt-get install -y wget ca-certificates lsb-release gnupg curl
          
          # Add PostgreSQL official APT repository with modern GPG key handling
          sudo mkdir -p /etc/apt/keyrings
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo gpg --dearmor -o /etc/apt/keyrings/postgresql.gpg
          echo "deb [signed-by=/etc/apt/keyrings/postgresql.gpg] http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
          sudo apt-get update
          
          # Install a basic PostgreSQL client to query server version
          # Try to install a recent version that can connect (we'll upgrade to exact match after)
          sudo apt-get install -y postgresql-client-17 || sudo apt-get install -y postgresql-client-16 || sudo apt-get install -y postgresql-client-15
          
          # Detect server version by querying the database
          echo "ğŸ” Detecting PostgreSQL server version..."
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo "âš ï¸  SUPABASE_DB_URL not set, defaulting to PostgreSQL 17"
            SERVER_VERSION="17"
          else
            # Query server version - extract major version number (e.g., "17.6" -> "17")
            SERVER_VERSION=$(psql "$SUPABASE_DB_URL" -t -c "SELECT substring(version() from 'PostgreSQL ([0-9]+)')" 2>/dev/null | tr -d ' ' || echo "")
            
            if [ -z "$SERVER_VERSION" ]; then
              echo "âš ï¸  Could not detect server version, defaulting to PostgreSQL 17"
              SERVER_VERSION="17"
            else
              echo "âœ… Detected PostgreSQL server version: $SERVER_VERSION"
            fi
          fi
          
          # Remove any existing PostgreSQL clients to avoid conflicts
          sudo apt-get remove -y postgresql-client postgresql-client-common postgresql-15 postgresql-client-15 postgresql-16 postgresql-client-16 postgresql-17 postgresql-client-17 2>/dev/null || true
          
          # Install the matching PostgreSQL client version
          echo "ğŸ“¦ Installing PostgreSQL client version $SERVER_VERSION..."
          if sudo apt-get install -y "postgresql-client-$SERVER_VERSION"; then
            echo "âœ… Successfully installed PostgreSQL client version $SERVER_VERSION"
          else
            echo "âŒ Failed to install PostgreSQL client version $SERVER_VERSION"
            echo "âš ï¸  Falling back to PostgreSQL 17"
            sudo apt-get install -y postgresql-client-17
            SERVER_VERSION="17"
          fi
          
          # Ensure PostgreSQL binaries are in PATH
          echo "/usr/lib/postgresql/$SERVER_VERSION/bin" >> $GITHUB_PATH
          
          # Verify pg_dump is available and show version
          if [ -f "/usr/lib/postgresql/$SERVER_VERSION/bin/pg_dump" ]; then
            echo "âœ… Using: $(/usr/lib/postgresql/$SERVER_VERSION/bin/pg_dump --version)"
          elif command -v pg_dump >/dev/null 2>&1; then
            echo "âœ… Using: $(pg_dump --version)"
          else
            echo "âš ï¸  Warning: pg_dump not found, but continuing..."
          fi

      - name: ğŸ” Check for pending migrations
        id: check_migrations
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          chmod +x scripts/check-pending-migrations.sh
          if ./scripts/check-pending-migrations.sh; then
            echo "has_pending=true" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ Pending migrations detected - backup will be created"
          else
            echo "has_pending=false" >> $GITHUB_OUTPUT
            echo "âœ¨ No pending migrations - skipping backup"
          fi

      - name: ğŸ’¾ Backup database (if migrations pending)
        if: steps.check_migrations.outputs.has_pending == 'true'
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REF: ${{ github.ref }}
        run: |
          chmod +x scripts/backup-with-metadata.sh
          mkdir -p database/backups
          ./scripts/backup-with-metadata.sh database/backups
          echo "ğŸ“¦ Backup created before migrations"

      - name: ğŸ“¦ Upload backup artifact
        if: steps.check_migrations.outputs.has_pending == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: db-backup-${{ github.run_id }}-${{ github.sha }}
          path: |
            database/backups/backup_*.sql
            database/backups/backup_*.metadata.json
          retention-days: 90
          if-no-files-found: ignore

      - name: ğŸ”„ Run database migrations
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          chmod +x scripts/run-migrations.sh
          ./scripts/run-migrations.sh

      - name: ğŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

      - name: âœ… Deployment complete
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          if [ "${{ steps.check_migrations.outputs.has_pending }}" == "true" ]; then
            echo "ğŸ’¾ Database backup created and stored as artifact"
          fi
          echo "ğŸ“Š Migrations applied"
          echo "ğŸŒ Application deployed to Vercel"

